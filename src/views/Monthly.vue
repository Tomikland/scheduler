<script lang="ts">
import Vue from "vue";
import { ipcRenderer } from "electron";
import { DayType } from "@/model/day-types";
import MonthlyRow from "@/components/MonthlyRow.vue";
import Popover from "@/components/Popover.vue";
import debounce from "lodash/debounce";
import { accumulators } from "@/model/aggregates"
import { FontColorFromBackground } from "@/utils/color-helpers"
import { isWeekend } from "@/utils/date-helpers"
import { clamp, throttle } from "lodash";
import staff, { Employee } from "@/model/staff"

export default Vue.extend({
	name: "Monthly",
	components: {
		MonthlyRow,
		Popover,
	},
	data() {
		return {
			sheet: this.$store.state.sheets.sheet,
			x: 4,
			drag: false,
			drag_employee_index: -1,
			drag_start: 0,
			drag_end: 0,
			popover: false,
			selection_start_rect: new DOMRect(),
			selection_end_rect: new DOMRect(),
			scroll: function () { },
			keydown: function (e: KeyboardEvent) { },
		};
	},
	created() {
		//Without throttling, holding down arrow keys makes the cursor move unreasonably fast,
		//but scrolling unreasonably slow (when combined with smooth scrolling)
		this.keydown = throttle(this.arrowKeys, 100);
		this.scroll = debounce(this.updateSelectRects, 50);

		window.addEventListener("mouseup", this.dragEndEmpty);
		window.addEventListener('keydown', this.keydown);

        ipcRenderer.on("zoom", () => {
            this.updateSelectRects();
        })

		if (this.$store.getters['staff/count'] < 1) {
			this.$store.commit("staff/add_employee", "Példa János_Lusta");
			this.$store.commit("staff/add_employee", "Példa János_Lusta2");
			this.$store.dispatch("staff/add", "Példa János");
			this.$store.dispatch("staff/add", "Példa János2");
			this.$store.dispatch("staff/add", "Példa János3");
		}

	},
	destroyed() {
		window.removeEventListener("mouseup", this.dragEndEmpty);
		window.removeEventListener('keydown', this.keydown);
	},
	methods: {
		getDayElement(index: number, day: number): Element {
			let name = this.sheet.GetRow(index).employee.name
			let row = this.$refs[name] as Vue[];

			let currDay = row[0].$children.find((e) => {
				if (!e.$props.day)
					throw `Az '${name}' sornak nincsenek leszármazottjai`;

				return e.$props.day == day;
			});
			if (!currDay) throw `Nem sikerült megtalálni ${day}. oszlopot.`;

			return currDay.$el;
		},
		getBounds(day: number, id = -1): DOMRect {
			if (id < 0) id = this.drag_employee_index;
			return this.getDayElement(id, day).getBoundingClientRect();
		},
		add() {
			this.$store.dispatch("staff/add", "Példa János" + this.x);
			this.x++;
		},
		setTableScroll(left: number, top: number) {
			let table = this.$refs.table as Element
			table.scrollLeft += left
			table.scrollTop += top
		},
		shift(name: string, day: number) {
			this.$store.dispatch('undo')
			// let d = this.sheet.GetRow(name).GetDay(day);
			// if (d.type == DayType.empty) {
			// 	this.$store.commit('set_shift', { name, day, start: 10, duration: 8 })
			// } else {
			// 	this.$store.commit("delete_shift", { name, day });
			// }
		},
		setShift({ start, duration }: { start: number, duration: number }) {
			for (let i of this.selection) {
				this.$store.dispatch('set_shift', { index: this.drag_employee_index, day: i, start, duration })
			}
		},
		setType(type: DayType) {
			for (let i of this.selection) {
				this.$store.dispatch('set_type', { index: this.drag_employee_index, day: i, type })
			}
		},
		arrowKeys(e: KeyboardEvent) {
			if(e.ctrlKey){
				if(e.key == "z"){
					this.undo();
				}
				if(e.key == "y"){
					this.redo();
				}
			}

			const bindings = {
				"ArrowRight": [1, 0],
				"ArrowLeft": [-1, 0],
				"ArrowUp": [0, -1],
				"ArrowDown": [0, 1]
			}
			const bind = Object.entries(bindings).find(b => b[0] == e.key)
			if (bind) {
				const [dx, dy] = bind[1] as [number, number]
				if (e.ctrlKey) {
					this.setTableScroll(dx * 40, dy * 40)
				} else {

					this.drag_end = clamp(this.drag_end + dx, 1, this.sheet.month_length)
					if (e.shiftKey == false)
						this.drag_start = this.drag_end;

					this.drag_employee_index = clamp(this.drag_employee_index + dy, 0, this.sheet.schedule.length - 1)
					this.updateSelectRects()
				}
			}

		},
		undo(){
			this.$store.dispatch('undo')
		},
		redo(){
			this.$store.dispatch('redo')
		},
		dragStart(index: number, day: number) {
			this.drag = true;
			this.drag_employee_index = index;
			this.drag_start = day;
			this.drag_end = day;
			this.popover = false;
		},
		dragEnter(index: number, day: number) {
			if (this.drag) {
				this.drag_end = day;
			}
		},
		dragEnd(index: number, day: number) {
			if (this.drag) {
				this.drag_end = day;
				this.popover = true;
			}
			this.updateSelectRects();
			this.drag = false;
		},
		dragEndEmpty() {
			this.dragEnd(this.drag_employee_index, this.drag_end);
		},
		deselect() {
			this.drag_employee_index = -1;
			this.drag_start = 0;
			this.drag_end = 0;
			this.popover = false;
		},
		updateSelectRects(): void {
			//computed properties update immediately which lead to popover moving as it fades out
			if (!this.drag_employee) return;
			this.selection_start_rect = this.getBounds(this.selection_start);
			this.selection_end_rect = this.getBounds(this.selection_end);
		},

	},
	computed: {
		drag_employee(): Employee | undefined {
			try {
				return this.sheet.GetRow(this.drag_employee_index).employee
			} catch {
				return undefined
			}
		},
		selection_start(): number {
			return Math.min(this.drag_start, this.drag_end);
		},
		selection_end(): number {
			return Math.max(this.drag_start, this.drag_end);
		},
		selection(): number[] {
			//(selection_start: 5, selection_end: 7) => [5,6,7]
			if (this.selection_end == 0) return []
			return Array(this.selection_end - this.selection_start + 1).fill(0).map((x, i) => i + this.selection_start);
		},
		right_side_headers(): string[] {
			return accumulators.map(a => a.label)
		},
		//Having this as computed so it's cached and doesn't run on every render
		header_styles(): Array<any> {
			return accumulators.map((a, i) => ({
				backgroundColor: a.header_color,
				color: FontColorFromBackground(a.header_color),
				right: (accumulators.length - 1 - i) * 3 + "em" //right side sticky columns
			}))
		},
		day_header_style(): Array<any> {
			return new Array(this.sheet.month_length).fill(1).map((a, i) => ({
				backgroundColor: isWeekend(new Date(this.sheet.year, this.sheet.month, i + 1)) ?
					"var(--v-header-weekend-base)" : "var(--v-header-weekday-base)",
			}))
		}
	},
});
</script>

<template>
	<div class="wrapper">
		<v-btn color="success" @click="add">Új dolgozó</v-btn>
		<v-btn color="success" @click="undo">Undo</v-btn>
		<v-btn color="success" @click="redo">Redo</v-btn>
		<popover
			v-model="popover"
			@close="deselect"
			@set-shift="setShift"
			@set-type="setType"
			:selected_start="selection_start_rect"
			:selected_end="selection_end_rect"></popover>
		<div class="table-wrapper" @scroll="scroll" ref="table">
			<table fixed-header class="table">
				<thead>
					<tr>
						<th class="text-center nametag">Név</th>
						<th class="text-center" :style="day_header_style[n - 1]" v-for="n in sheet.month_length" :key="n">
							{{ n }}
						</th>
						<th class="header-sticky-right acc-header" v-for="(acc, i) in right_side_headers" :key="acc"
							:style="header_styles[i]">{{acc}}</th>
					</tr>
				</thead>
				<tbody>
					<monthly-row
						v-for="(row, i) in this.sheet.schedule"
						:key="row.employee.name"
						:employee_name="row.employee.name"
						:days="row.days"
						:selection="i == drag_employee_index ? selection: []"
						:ref="row.employee.name"
						@day-mouse-down="dragStart(i, $event)"
						@day-mouse-up="dragEnd(i, $event)"
						@day-mouse-enter="dragEnter(i, $event)" />
				</tbody>
			</table>
		</div>
	</div>
</template>

<style>
.wrapper {
	max-height: 100%;
}
.nametag {
	min-width: 10em;
	border-right-style: double;
}
.acc-header {
	min-width: 3em;
}
.header-sticky-right {
	position: sticky;
	/* right: 0; */
	z-index: 2;
}
.table-wrapper {
	overflow: auto;
	position: relative;
	border: 1px solid #eee;
	max-height: 75vh;
	scroll-behavior: smooth;
}
table {
	position: relative;
	border-collapse: separate;
	table-layout: fixed;
	user-select: none;
	border-spacing: 0;
}

thead th {
	position: sticky;
	top: 0;
	background: #000;
	color: #fff;
	z-index: 1;
}

thead th:first-child {
	left: 0;
	z-index: 2;
}

tbody th {
	position: sticky;
	left: 0;
	background: #fff;
	border: 1px solid #ccc;
}
</style>
